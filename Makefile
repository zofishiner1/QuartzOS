# ============== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==============
KERNEL_ASM = kernel/kernel.asm
KERNEL_C = kernel/kernel.c
ATA_DISK_C = modules/disk/ata_disk.c
ATA_DISK_H = modules/disk/ata_disk.h
COLORS_H = templates/colors.h
OUTPUT_ISO = QuartzOS.iso
LINKER_SCRIPT = kernel/link.ld
BUILD_DIR = build
ISO_DIR = $(BUILD_DIR)/iso
GRUB_CFG = $(ISO_DIR)/boot/grub/grub.cfg
DISK_SIZE ?= 200
RAM_SIZE ?= 16

# ============== –í–ï–†–°–ò–Ø –Ø–î–†–ê ==============
KERNEL_VERSION_MAJOR = 1
KERNEL_VERSION_MINOR = 2
KERNEL_VERSION_PATCH = 0
KERNEL_VERSION_SUFFIX = -alpha
VERSION_HEADER = kernel/version.h

# ============== –ü–ê–†–ê–ú–ï–¢–†–´ –°–ë–û–†–ö–ò ==============
CFLAGS = -m32 -ffreestanding -fno-stack-protector -Wall -Wextra -O2 -Ikernel

LDFLAGS = -m elf_i386 -T $(LINKER_SCRIPT) -nostdlib -z noexecstack

# ============== –¶–ï–õ–ò ==============
.PHONY: all iso qemu clean version update_version

# –ë–µ–∑—É—Å–ª–æ–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ version.h
update_version:
	@echo "// Auto-generated by Makefile" > $(VERSION_HEADER)
	@echo "#pragma once" >> $(VERSION_HEADER)
	@echo "#define KERNEL_VERSION_MAJOR $(KERNEL_VERSION_MAJOR)" >> $(VERSION_HEADER)
	@echo "#define KERNEL_VERSION_MINOR $(KERNEL_VERSION_MINOR)" >> $(VERSION_HEADER)
	@echo "#define KERNEL_VERSION_PATCH $(KERNEL_VERSION_PATCH)" >> $(VERSION_HEADER)
	@echo "#define KERNEL_VERSION_SUFFIX \"$(KERNEL_VERSION_SUFFIX)\"" >> $(VERSION_HEADER)
	@echo "#define KERNEL_VERSION_STRING \\" >> $(VERSION_HEADER)
	@echo "    \"$(KERNEL_VERSION_MAJOR).$(KERNEL_VERSION_MINOR).$(KERNEL_VERSION_PATCH)$(KERNEL_VERSION_SUFFIX)\"" >> $(VERSION_HEADER)

all: update_version iso qemu

# ============== –°–ë–û–†–ö–ê –û–ë–™–ï–ö–¢–ù–´–• –§–ê–ô–õ–û–í ==============
$(BUILD_DIR)/kasm.o: $(KERNEL_ASM)
	@echo "üî® –°–±–æ—Ä–∫–∞ assembler-—Ñ–∞–π–ª–∞..."
	@mkdir -p $(BUILD_DIR)
	@nasm -f elf32 $< -o $@

$(BUILD_DIR)/kc.o: $(KERNEL_C) $(COLORS_H) $(VERSION_HEADER)
	@echo "üî® –°–±–æ—Ä–∫–∞ C-—Ñ–∞–π–ª–∞ kernel.c..."
	@mkdir -p $(BUILD_DIR)
	@gcc $(CFLAGS) -c $< -o $@

$(BUILD_DIR)/ata_disk.o: $(ATA_DISK_C) $(ATA_DISK_H)
	@echo "üî® –°–±–æ—Ä–∫–∞ C-—Ñ–∞–π–ª–∞ ata_disk.c..."
	@mkdir -p $(BUILD_DIR)
	@gcc $(CFLAGS) -c $(ATA_DISK_C) -o $@

# ============== –ö–û–ú–ü–û–ù–û–í–ö–ê –Ø–î–†–ê ==============
$(BUILD_DIR)/kernel: $(BUILD_DIR)/kasm.o $(BUILD_DIR)/kc.o $(BUILD_DIR)/ata_disk.o
	@echo "üîó –ö–æ–º–ø–æ–Ω–æ–≤–∫–∞ —è–¥—Ä–∞..."
	@ld $(LDFLAGS) -o $@ $^

# ============== –°–û–ó–î–ê–ù–ò–ï –û–ë–†–ê–ó–ê ISO ==============
$(GRUB_CFG): templates/grub.cfg
	@echo "üìÑ –°–æ–∑–¥–∞–Ω–∏–µ grub.cfg..."
	@mkdir -p $(dir $@)
	@cp templates/grub.cfg $@

$(ISO_DIR)/boot/kernel: $(BUILD_DIR)/kernel
	@echo "‚öôÔ∏è –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —è–¥—Ä–∞ –≤ ISO..."
	@mkdir -p $(dir $@)
	@cp $< $@

iso: $(GRUB_CFG) $(ISO_DIR)/boot/kernel
	@echo "üìÄ –°–æ–∑–¥–∞–Ω–∏–µ ISO –æ–±—Ä–∞–∑–∞..."
	@grub-mkrescue -o $(OUTPUT_ISO) $(ISO_DIR) 2>/dev/null

# ============== –°–û–ó–î–ê–ù–ò–ï –ò –ó–ê–ü–£–°–ö QEMU ==============
qemu: iso
	@echo "üöÄ –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞ –¥–∏—Å–∫–∞ –∏ –∑–∞–ø—É—Å–∫ QEMU..."
	@qemu-img create -f raw quartzos.img ${DISK_SIZE}M
	@qemu-system-i386 -m ${RAM_SIZE} \
		-drive format=raw,file=quartzos.img \
		-cdrom $(OUTPUT_ISO) \
		-boot order=d \
		-vga std \
		-full-screen

# ============== –í–´–í–û–î –í–ï–†–°–ò–ò ==============
version:
	@echo "Kernel version: $(KERNEL_VERSION_MAJOR).$(KERNEL_VERSION_MINOR).$(KERNEL_VERSION_PATCH)$(KERNEL_VERSION_SUFFIX)"

# ============== –£–ë–û–†–ö–ê ==============
clean:
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞..."
	@rm -rf $(BUILD_DIR) $(OUTPUT_ISO) quartzos.img $(VERSION_HEADER)
